{% extends "../base/layout.html" %}

{% set tabActive = "analyses" %}

{% block ngApp %} ng-app="terrama2.analysis.registration" {% endblock %}

{% block title %} TerraMA2 {[ __('Analysis Registration') ]} {% endblock %}

{% block styles %}
  <style>
    table > tbody {
      overflow-y: auto !important;
      height: 150px !important;
    }
  </style>
{% endblock %}

{% block javascripts %}

<!-- Angular -->
<script type="text/javascript" src="/externals/angular/angular.min.js"></script>

<!-- Angular Schema Form dependencies -->
<script type="text/javascript" src="/externals/angular-sanitize/angular-sanitize.js"></script>
<script type="text/javascript" src="/externals/tv4/tv4.min.js"></script>
<script type="text/javascript" src="/externals/objectpath/ObjectPath.js"></script>
<script type="text/javascript" src="/externals/angular-schema-form/schema-form.js"></script>
<script type="text/javascript" src="/externals/bootstrap/js/bootstrap-decorator.min.js"></script>

<!-- terrama2 Angular app -->
<script type="text/javascript" src="/javascripts/angular/app.js"></script>

<!-- Angular i18n -->
<script type="text/javascript" src="/externals/angular/i18n-angular.min.js"></script>

<!-- Ace editor -->
<script type="text/javascript" src="/externals/ace-editor/ace.js"></script>
<script type="text/javascript" src="/externals/ace-editor/ext-language_tools.js"></script>

<!-- Socket.io -->
<script type="text/javascript" src="/socket.io/socket.io.js"></script>

<!-- terrama2 Script -->
<script type="text/javascript" src="/javascripts/terrama2.js"></script>

<script type="text/javascript" src="/javascripts/angular/services.js"></script>
<script type="text/javascript" src="/javascripts/angular/alert-box/directives.js"></script>
<script type="text/javascript" src="/javascripts/angular/analysis/registration.js"></script>

<script type="text/javascript" src="/externals/moment/moment.js"></script>

<script type="text/javascript">
  ace.require("ace/ext/language_tools");

  var editor = ace.edit("script");
  editor.setTheme("ace/theme/chrome");
  editor.getSession().setMode("ace/mode/python");

  editor.setOptions({
    fontSize: "12pt",
    enableBasicAutocompletion: true,
    enableSnippets: true,
    enableLiveAutocompletion: false
  });

  var textarea = $('textarea[name="script"]').hide();
  editor.getSession().setValue(textarea.val());
  editor.getSession().on('change', function() {
    textarea.val(editor.getSession().getValue());
    // notify angular
    $(textarea).trigger('input');
  });
</script>

{% endblock %}

{% block content %}

<div class="col-md-12" ng-controller="AnalysisRegistration">
  <div class="box box-default">
    <div class="box-header with-border">
      <h3 class="box-title">{[ __('Analysis Registration') ]}</h3>
    </div>
    <!-- /.box-header -->
    <div style="display: block;" class="box-body">

      <div class="col-md-12">
        <div class="box box-default box-solid">
          <div class="box-header with-border">
            <h3 class="box-title">{[ __('General Data') ]}</h3>
            <div class="box-tools pull-right">
              <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
              </button>
            </div>
          </div>
          <!-- /.box-header -->
          <div style="display: block;" class="box-body">
            <div class="row">
              <div class="col-md-12">
                <terrama2-alert-box alert-level="alertLevel" title="alertBox.title" message="alertBox.message" display-handler="display" close="close()"></terrama2-alert-box>
              </div>

              <form name="generalDataForm">
                <div class="col-md-8">
                  <div class="form-group" ng-class="{'has-error': generalDataForm.name.$dirty && generalDataForm.name.$error.required,
                                                     'has-success': generalDataForm.name.$dirty && generalDataForm.name.$valid}">
                    <label>{[ __("Name") ]}:</label>
                    <input class="form-control" name="name" ng-model="analysis.name" placeholder="{[ __('Analysis Name') ]}" type="text" required>

                    <span class="help-block" ng-show="generalDataForm.name.$dirty && generalDataForm.name.$invalid" ng-class="{'has-error': generalDataForm.name.$invalid}">{[ __('Analysis name is required') ]}</span>
                  </div>
                </div>
                <!-- /.col -->

                <div class="col-md-4">
                  <div class="form-group has-feedback" ng-class="{'has-error': generalDataForm.type.$dirty && generalDataForm.type.$error.required,
                                                     'has-success': generalDataForm.type.$dirty && generalDataForm.type.$valid}">
                    <label>{[ __("Type") ]}:</label>
                    <select class="form-control" name="type" ng-model="analysis.type_id" required>
                      <option value="1">DCP</option>
                      <option value="2">Occurrence</option>
                      <option value="3">Grid</option>
                      <option value="3">Monitored Object</option>
                    </select>

                    <span class="help-block" ng-show="generalDataForm.type.$dirty && generalDataForm.type.$error.required"
                          ng-class="{'has-error': generalDataForm.type.$invalid}">
                      {[ __('Analysis type is required') ]}
                    </span>
                  </div>
                  <!-- /.form-group -->
                </div>

                <div class="col-md-12">
                  <div class="form-group">
                    <label>{[ __("Description") ]}:</label>
                    <textarea class="form-control" name="description" ng-model="analysis.description" rows="3" placeholder="{[ __('Analysis Description') ]}"></textarea>
                  </div>
                  <!-- /.form-group -->
                </div>

                <div class="col-md-8">
                  <div class="form-group has-feedback" ng-class="{'has-error': generalDataForm.instance.$dirty && generalDataForm.instance.$error.required,
                                                     'has-success': generalDataForm.instance.$dirty && generalDataForm.instance.$valid}">
                    <label>{[ __("Instance") ]}:</label>
                    <select class="form-control" name="instance" ng-model="analysis.instance_id" required>
                      <option ng-repeat="instance in instances" value="{{ instance.id }}">{{ instance.name }}</option>
                      <option ng-if="instances.length == 0">{[ __('No analysis instance found') ]}</option>
                    </select>

                    <span class="help-block" ng-show="generalDataForm.instance.$dirty && generalDataForm.instance.$error.required"
                          ng-class="{'has-error': generalDataForm.instance.$invalid}">
                      {[ __('Analysis instance is required') ]}
                    </span>
                  </div>
                  <!-- /.form-group -->
                </div>

                <div class="col-md-4">
                  <div class="form-group">
                    <div class="form-group">
                      <div class="checkbox">
                        <label style="font-weight: 700; margin-top:19px;">
                          <input name="active" ng-model="analysis.active" ng-init="analysis.active = true" type="checkbox"> {[ __("Active") ]}
                        </label>
                      </div>
                    </div>

                  </div>
                  <!-- /.form-group -->
                </div>
              </form>
              <!--./ generalDataForm -->
            </div>
            <!-- /.row -->
          </div>
          <!-- /.box body -->
        </div>
      </div>

      <div class="col-md-12">
        <div class="box box-default box-solid">
          <div class="box-header with-border">
            <h3 class="box-title">{[ __('Storager') ]}</h3>
            <div class="box-tools pull-right">
              <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
              </button>
            </div>
          </div>
          <!-- /.box-header -->
          <div style="display: block;" class="box-body">
            <div class="row">

              <form name="storagerDataForm">

                <div class="col-md-4">
                  <div class="form-group">
                    <label>{[ __('Output Format') ]}:</label>
                      <select id="storageFormat" class="form-control" name="format" ng-change="onStoragerFormatChange()" ng-model="storager.format" ng-options="format.name for format in storagerFormats">
                    </select>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="form-group" ng-class="{'has-error': storagerDataForm.storager_data_provider_id.$dirty && storagerDataForm.storager_data_provider_id.$error.required,
                                  'has-success': storagerDataForm.storager_data_provider_id.$dirty && storagerDataForm.storager_data_provider_id.$valid}">
                    <label>{[ __('Provider Output') ]}:</label>
                    <select class="form-control" name="storager_data_provider_id" ng-model="storager_data_provider_id" ng-options="provider.id as provider.name for provider in dataProviders" ng-required="storager.format.name">
                      <option></option>
                    </select>
                    <label class="help-block text-danger" ng-show="storagerDataForm.storager_data_provider_id.$dirty && storagerDataForm.storager_data_provider_id.$error.required">
                      {[ __("Data provider is required") ]}
                    </label>
                  </div>
                </div>
              </form>
              <div class="col-md-12 terrama2-nopadding-box" ng-controller="StoragerController">
                <!-- schema form -->
                <div class="col-md-12" ng-show="showStoragerForm">
                  <form name="storagerForm" sf-schema="schemaStorager" sf-form="formStorager" sf-model="modelStorager" sf-options="options"></form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-12">
        <div class="box box-default box-solid" id="dataSeriesBox">
          <div class="box-header with-border">
            <h3 class="box-title">{[ __('Data Series') ]}</h3>

            <div class="box-tools pull-right">
              <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
              </button>
            </div>
          </div>

          <!-- /.box-header -->
          <div style="display: block;" class="box-body">
            <div class="row">
              <div class="col-md-12">
                <table class="table table-bordered table-hover">
                  <tbody>
                  <tr>
                    <th>{[ __('Name') ]}</th>
                    <th>{[ __('Type') ]}</th>
                  </tr>
                  <tr style="cursor:pointer;" ng-repeat="dataSeries in dataSeriesList" data-ng-click="onDataSeriesClick(dataSeries);" ng-class="{'active': selectedDataSeries && selectedDataSeries.name == dataSeries.name}">
                    <td>{{ dataSeries.name }}</td>
                    <td>{{ dataSeries.semantics }}</td>
                  </tr>
                  <tr ng-if="dataSeriesList.length == 0">
                    <td colspan="2">
                      {[ __('No data series found') ]}
                    </td>
                  </tr>
                  </tbody>
                </table>
                <!--./table-->
                <!--todo: open box-->

                <div class="col-md-12 terrama2-nopadding-box" ng-if="selectedDataSeries">
                  <div class="box box-default box-solid">
                    <div class="box-header with-border">
                      <h3 class="box-title">{{ selectedDataSeries.name }}</h3>
                    </div>

                    <div style="display: block;" class="box-body">
                      <div class="row">
                        <div class="col-md-12">
                          <!-- metadata form handler -->
                          <form name="metadataForm">
                            <!-- dcp -->
                            <!-- ng-if="semantics.data_series_type_name === 'Dcp'" -->
                            <div >
                              <div class="col-md-12 terrama2-nopadding-box">
                                <div class="col-md-4">
                                  <div class="form-group has-feedback">
                                    <label>{[ __("Influence") ]}:</label>
                                    <select class="form-control" name="influence" ng-model="metadata.key" required>
                                      <option value="Radius">{[ __('Radius') ]}</option>
                                    </select>
                                  </div>
                                </div>
                              </div>

                              <div class="col-md-12 terrama2-nopadding-box">

                                <div class="col-md-8">
                                  <div class="form-group">
                                    <label>{[ __("Radius") ]}:</label>
                                    <input class="form-control" name="radius" type="text" ng-model="metadata.value">
                                  </div>
                                </div>

                                <div class="col-md-4">
                                  <div class="input-group" style="margin-top: 25px;">
                                    <input type="text" class="form-control" aria-label="..." ng-model="metadata.format">
                                    <div class="input-group-btn">
                                      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span>
                                      </button>
                                      <ul class="dropdown-menu dropdown-menu-right">
                                        <li data-ng-click="onMetadataFormatClick('km')"><a href="#dataSeriesBox">km</a></li>
                                        <li data-ng-click="onMetadataFormatClick('m')"><a href="#dataSeriesBox">m</a></li>
                                      </ul>
                                    </div><!-- /btn-group -->
                                  </div><!-- /input-group -->
                                </div><!-- /.col-md-4 -->
                              </div><!--/.col-md-12-->
                            </div>

                            <!-- Occurrence -->
                            <div ng-if="semantics.data_series_type_name === 'Occurrence'">
                              <div class="col-md-12 terrama2-nopadding-box">
                              </div>
                            </div>
                          </form><!--/.metadataForm-->
                        </div><!--./col-md-12-->
                      </div>
                    </div><!-- ./box-body-->
                  </div><!--./box-solid-->
                </div><!--./col-md-12-->
              </div><!--./col-md-12-->
            </div><!--./row-->
          </div><!--./box-body-->
        </div><!--./box-->
      </div>

      <div class="col-md-12">
        <div class="box box-default box-solid">
          <div class="box-header with-border">
            <h3 class="box-title">{[ __('Script') ]}</h3>

            <div class="box-tools pull-right">
              <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
              </button>
            </div>
          </div>

          <!-- /.box-header -->
          <div style="display: block;" class="box-body">
            <div class="row">

              <div class="col-md-12">
                <form name="scriptForm">
                  <div class="form-group" ng-class="{'has-error': scriptForm.script.$dirty && scriptForm.script.$error.required,
                                                     'has-success': scriptForm.script.$dirty && scriptForm.script.$valid}">

                    <!-- todo: adding helper functions, syntax validation and syntax highlighter -->
                    <label>{[ __('Analysis Model') ]}:</label>
                    <div id="scriptCheckResult"></div>
                    <div id="systemError" style="display: none;"></div>
                    <div id="script"></div>
                    <textarea name="script" ng-model="analysis.script" required></textarea>

                    <!-- required -->
                    <span class="help-block"
                          ng-show="scriptForm.script.$dirty && scriptForm.script.$error.required">
                      {[ __('Analysis script is required') ]}
                    </span>

                    <!-- todo: syntax error message -->
                  </div>
                </form>

                <div class="col-md-12">
                  <div class="btn-group">
                    <button aria-expanded="false" type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown">
                      {[ __('Functions') ]}
                    </button>
                    <ul class="dropdown-menu" role="menu">
                      <li><a href="#">max</a></li>
                      <li><a href="#">min</a></li>
                      <li><a href="#">abs</a></li>
                    </ul>
                  </div>

                  <button class="btn btn-default pull-right" id="checkAnalysisScript">{[ __('Validate') ]}</button>
                </div>
              </div>
            </div>
            <!-- /.row -->
          </div>
          <!-- /.box body -->
        </div>
      </div> <!-- end col md 6 -->

    </div>
    <!-- /.box body -->

    <div class="box-footer">
      <button class="btn btn-primary pull-right" style="margin-left: 10px;" data-ng-click="save();" id="analysisSaveButton" disabled="disabled">{[ __('OK') ]}</button>
      <a href="/configuration/analyses/" class="btn btn-primary pull-right" style="margin-left: 10px;">{[ __('Cancel') ]}</a>
    </div>
  </div>
</div> <!-- end col md 12 -->

{% endblock %}
