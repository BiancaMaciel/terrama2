{% extends "../base/layout.html" %}

{% set tabActive = "projects" %}

{% block styles %}
<link rel="stylesheet" type="text/css" href="/bower_components/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css">
{% endblock %}

{% block ngApp %} ng-app="terrama2.projects" {% endblock %}

{% block title %} TerraMAÂ² {{ i18n.__('Projects') }} {% endblock %}

{% block javascripts %}
<!-- Socket.io -->
<script type="text/javascript" src="/socket.io/socket.io.js"></script>

<script src="/javascripts/angular/services.js"></script>
<script src="/javascripts/angular/table/table.js"></script>
<script src="/javascripts/angular/alert-box/directives.js"></script>
<script type="text/javascript">
  angular.module("terrama2.projects", ['terrama2', 'terrama2.table', 'terrama2.components.messagebox', 'terrama2.services'])
    .controller("ProjectController", function($scope, $http, Socket, FileDialog, SaveAs, $log, i18n, AnalysisFactory) {
      $scope.model = [];
      $log.warn("initializing");
      var socket = Socket;
      $scope.i18n = i18n;
      $scope.linkToAdd = "/configuration/projects/new";
      $scope.fields = [
        {key: "name", as: i18n.__("Name")},
        {key: "description", as: i18n.__("Description")}
      ];
      $scope.iconProperties = {};
      $scope.loading = true;
      $scope.projectsCheckboxes = {};
      $scope.projectRadio = null;
      $scope.exportData = {
        "Projects": [],
        "DataProviders": [],
        "DataSeries": [],
        "Collectors": [],
        "Analysis": [],
        "Views": []
      };

      var setError = function(err) {
        $scope.display = true;
        $scope.alertLevel = "alert-danger";
        $scope.alertBox.message = err.toString();
        $scope.extra.isImporting = false;
      };

      $scope.remove = function(object) {
        return "/api/Project/" + object.id + "/delete";
      };

      $scope.link = function(object) {
        return "/configuration/projects/" + object.name + "/activate";
      };

      $scope.projectCheck = function(element) {
        if($scope.projectsCheckboxes[element.id].project) {
          if($scope.projectsCheckboxes[element.id].dataProviders != undefined) {
            for(var property in $scope.projectsCheckboxes[element.id].dataProviders) {
              if($scope.projectsCheckboxes[element.id].dataProviders.hasOwnProperty(property))
                $scope.projectsCheckboxes[element.id].dataProviders[property] = true;
            }
          }

          if($scope.projectsCheckboxes[element.id].dataSeries != undefined) {
            for(var property in $scope.projectsCheckboxes[element.id].dataSeries) {
              if($scope.projectsCheckboxes[element.id].dataSeries.hasOwnProperty(property))
                $scope.projectsCheckboxes[element.id].dataSeries[property] = true;
            }
          }

          if($scope.projectsCheckboxes[element.id].analysis != undefined) {
            for(var property in $scope.projectsCheckboxes[element.id].analysis) {
              if($scope.projectsCheckboxes[element.id].analysis.hasOwnProperty(property))
                $scope.projectsCheckboxes[element.id].analysis[property] = true;
            }
          }

          if($scope.projectsCheckboxes[element.id].views != undefined) {
            for(var property in $scope.projectsCheckboxes[element.id].views) {
              if($scope.projectsCheckboxes[element.id].views.hasOwnProperty(property))
                $scope.projectsCheckboxes[element.id].views[property] = true;
            }
          }
        }
      };

      // alert-box
      $scope.alertLevel = "alert-success";
      $scope.alertBox = {
        title: i18n.__("{[ context ]}" || "Project"),
        message: "{[ message ]}"
      };
      $scope.resetState = function() { $scope.display = false; };

      socket.on("exportResponse", function(result) {
        $scope.extra.isExporting = false;
        $scope.display = result.err ? true : false;
        if (result.err) {
          $scope.alertLevel = "alert-danger";
          $scope.alertBox.message = result.err;
          console.log("Err ", result.err);
          return;
        }

        //SaveAs(result.data, result.data.Projects[0].name + ".terrama2");
        SaveAs(result.data, "export.terrama2");
      });

      socket.on("importResponse", function(result) {
        $scope.loading = false;
        $scope.display = true;
        $scope.extra.isImporting = false;
        if (result.err) {
          $scope.alertLevel = "alert-danger";
          console.log("Err ", result.err);
          $scope.alertBox.message = result.err;
          return;
        }
        $scope.alertLevel = "alert-success";

        if(result.data.Projects !== undefined && result.data.Projects.length > 0) {
          var msg = result.data.Projects.length + i18n.__(" projects has been imported. ");
          var canPush = [];

          for(var i = 0; i < result.data.Projects.length; ++i) {
            var p = result.data.Projects[i];
            var cont = 0;
            for(var j = 0; j < $scope.model.length; ++j) {
              var modelProject = $scope.model[j];
              if (p.name === modelProject.name) {
                // skip it
                break;
              }
              ++cont;
            }
            if (cont === $scope.model.length) {
              // push
              $scope.model.push(p);
            }
            cont = 0;
          }
        } else {
          var msg = i18n.__(" The data has been imported. ");
        }

        $scope.alertBox.message = msg;
      });

      // callback after remove operation
      $scope.extra = {
        importJson: null,

        removeOperationCallback: function(err, data) {
          $scope.display = true;
          if (err) {
            $scope.alertLevel = "alert-danger";
            $scope.alertBox.message = err.message;
            return;
          }

          $scope.alertLevel = "alert-success";
          $scope.alertBox.message = data.name + " removed";
        },

        project: {
          edit: function(element) {
            return "/configuration/projects/edit/" + element.name;
          }
        },

        openExportModal: function(element) {
          if(!element) return;

          $scope.currentProjectId = element.id;
          $('#exportModal').modal('show');
        },

        export: function(element) {
          if(!element) return;

          if($scope.projectsCheckboxes[element.id] != undefined) {
            if($scope.projectsCheckboxes[element.id].project) {
              $scope.exportData.Projects.push(element);

              delete $scope.exportData.DataProviders;
              delete $scope.exportData.DataSeries;
              delete $scope.exportData.Collectors;
              delete $scope.exportData.Analysis;
              delete $scope.exportData.Views;
            } else {
              if($scope.projectsCheckboxes[element.id].dataProviders != undefined) {
                for(var j = 0, dataProvidersLength = $scope.dataProviders[element.id].length; j < dataProvidersLength; j++) {
                  if($scope.projectsCheckboxes[element.id].dataProviders[$scope.dataProviders[element.id][j].id])
                    $scope.exportData.DataProviders.push($scope.dataProviders[element.id][j]);
                }
              }

              if($scope.projectsCheckboxes[element.id].dataSeries != undefined) {
                for(var j = 0, dataSeriesLength = $scope.dataSeries[element.id].length; j < dataSeriesLength; j++) {
                  if($scope.projectsCheckboxes[element.id].dataSeries[$scope.dataSeries[element.id][j].id]) {
                    $scope.exportData.DataSeries.push($scope.dataSeries[element.id][j]);

                    for(var x = 0, collectorsLength = $scope.collectors[element.id].length; x < collectorsLength; x++) {
                      if($scope.collectors[element.id][x].output_data_series === $scope.dataSeries[element.id][j].id) {
                        $scope.exportData.Collectors.push($scope.collectors[element.id][x]);
                        break;
                      }
                    }
                  }
                }
              }

              if($scope.projectsCheckboxes[element.id].analysis != undefined) {
                for(var j = 0, analysisLength = $scope.analysis[element.id].length; j < analysisLength; j++) {
                  if($scope.projectsCheckboxes[element.id].analysis[$scope.analysis[element.id][j].id])
                    $scope.exportData.Analysis.push($scope.analysis[element.id][j]);
                }
              }

              if($scope.projectsCheckboxes[element.id].views != undefined) {
                for(var j = 0, viewsLength = $scope.views[element.id].length; j < viewsLength; j++) {
                  if($scope.projectsCheckboxes[element.id].views[$scope.views[element.id][j].id])
                    $scope.exportData.Views.push($scope.views[element.id][j]);
                }
              }

              if($scope.exportData.Projects.length == 0) delete $scope.exportData.Projects;
              if($scope.exportData.DataProviders.length == 0) delete $scope.exportData.DataProviders;
              if($scope.exportData.DataSeries.length == 0) delete $scope.exportData.DataSeries;
              if($scope.exportData.Collectors.length == 0) delete $scope.exportData.Collectors;
              if($scope.exportData.Analysis.length == 0) delete $scope.exportData.Analysis;
              if($scope.exportData.Views.length == 0) delete $scope.exportData.Views;
            }
          }

          $scope.extra.isExporting = true;
          $scope.exportData['currentProjectId'] = $scope.currentProjectId;
          socket.emit("export", $scope.exportData);

          $scope.exportData = {
            "Projects": [],
            "DataProviders": [],
            "DataSeries": [],
            "Collectors": [],
            "Analysis": [],
            "Views": []
          };

          $('#exportModal').modal('hide');
        },

        import: function() {
          $scope.alertBox.title = i18n.__("Data Import");
          $scope.display = false;
          $scope.extra.isImporting = false;

          FileDialog.openFile(function(err, input) {
            if (err) {
              $scope.display = true;
              $scope.alertBox.message = err.toString();
              return;
            }

            $scope.loading = true;
            FileDialog.readAsJSON(input.files[0], function(error, json) {
              // applying angular scope..
              $scope.$apply(function() {
                $scope.extra.isImporting = true;
                if (error) {
                  setError(error);
                  console.log(error);
                  return;
                } else {
                  $scope.display = false;
                }

                if (!json.hasOwnProperty("Projects") &&
                    !json.hasOwnProperty("DataSeries") &&
                    !json.hasOwnProperty("DataProviders") &&
                    !json.hasOwnProperty("Analysis") &&
                    !json.hasOwnProperty("Collectors") &&
                    !json.hasOwnProperty("Views")) {
                  setError(new Error("Invalid configuration file"));
                  return;
                }

                if(json.Projects !== undefined && json.Projects.length > 0) {
                  socket.emit("import", json);
                } else {
                  $scope.extra.isImporting = false;
                  $scope.extra.importJson = json;
                  $('#importModal').modal('show');
                }
              });
            });
          }, false, ".terrama2, .json, application/json");
        },

        finalizeImportation: function() {
          if($scope.projectRadio === null) {
            setError(new Error("Select a project"));
            $('#importModal').modal('hide');
          } else {
            $scope.extra.isImporting = true;
            $scope.extra.importJson['selectedProject'] = $scope.projectRadio;
            socket.emit("import", $scope.extra.importJson);
            $('#importModal').modal('hide');
          }
        }
      };

      $scope.display = {% if message %}true{% else %} false{% endif %};

      $http.get("/api/Project/", {}).success(function(projects) {
        $scope.model = projects;
        $scope.dataProviders = {};
        $scope.dataSeries = {};
        $scope.analysis = {};
        $scope.views = {};
        $scope.collectors = {};

        projects.map(function(project, index) {
          if($scope.projectsCheckboxes[project.id] == undefined)
            $scope.projectsCheckboxes[project.id] = {
              project: false
            };

          $http.get("/api/DataProvider/project/" + project.id, {}).success(function(dataProviders) {
            $scope.dataProviders[project.id] = dataProviders;

            if($scope.projectsCheckboxes[project.id].dataProviders == undefined)
              $scope.projectsCheckboxes[project.id].dataProviders = {};

            for(var j = 0, dataProvidersLength = dataProviders.length; j < dataProvidersLength; j++) {
              $scope.projectsCheckboxes[project.id].dataProviders[dataProviders[j].id] = false;
            }
          }).error(function(err) {
            console.log("Err in retrieving data providers");
          }).finally(function() {
            $scope.loading = false;
          });

          $http({
            url: "/api/DataSeries/project/" + project.id,
            method: "GET",
            params: {
              collector: true,
              type: "dynamic",
              ignoreAnalysisOutputDataSeries: true
            }
          }).then(
            function(dataSeries) {
              $scope.dataSeries[project.id] = dataSeries.data;

              if($scope.projectsCheckboxes[project.id].dataSeries == undefined)
                $scope.projectsCheckboxes[project.id].dataSeries = {};

              for(var j = 0, dataSeriesLength = dataSeries.data.length; j < dataSeriesLength; j++) {
                $scope.projectsCheckboxes[project.id].dataSeries[dataSeries.data[j].id] = false;
              }
            }, function(err) {
              console.log("Err in retrieving data series");
            }
          ).finally(function() {
            $scope.loading = false;
          });

          AnalysisFactory.get({ project_id: project.id }).success(function(analysis) {
            $scope.analysis[project.id] = analysis;

            if($scope.projectsCheckboxes[project.id].analysis == undefined)
              $scope.projectsCheckboxes[project.id].analysis = {};

            for(var j = 0, analysisLength = analysis.length; j < analysisLength; j++) {
              $scope.projectsCheckboxes[project.id].analysis[analysis[j].id] = false;
            }
          }).error(function(err) {
            $log.info("Err in retrieving Analysis " + err);
          }).finally(function() {
            $scope.loading = false;
          });

          $http.get("/api/View", {}).success(function(views) {
            $scope.views[project.id] = views;

            if($scope.projectsCheckboxes[project.id].views == undefined)
              $scope.projectsCheckboxes[project.id].views = {};

            for(var j = 0, viewsLength = views.length; j < viewsLength; j++) {
              $scope.projectsCheckboxes[project.id].views[views[j].id] = false;
            }
          }).error(function(err) {
            console.log("Err in retrieving views");
          }).finally(function() {
            $scope.loading = false;
          });

          $http.get("/api/Collector/project/" + project.id, {}).success(function(collectors) {
            $scope.collectors[project.id] = collectors;
          }).error(function(err) {
            console.log("Err in retrieving collectors");
          }).finally(function() {
            $scope.loading = false;
          });
        });
      }).error(function(err) {
        console.log("Err in retrieving projects");
      }).finally(function() {
        $scope.loading = false;
      });
    });
</script>

{% endblock %}

{% block content %}
<div ng-controller="ProjectController">
  <terrama2-box title="i18n.__('Projects')">
    <div class="row">
      <div class="col-md-12">
        <div class="col-md-12">
          <terrama2-alert-box alert-level="alertLevel" title="alertBox.title" message="alertBox.message" close="resetState()" display-handler="display"></terrama2-alert-box>
        </div>

        <terrama2-table fields="fields" model="model" link="link" icon-properties="iconProperties"
                        link-to-add="linkToAdd" icon="iconFn" context="'project'" remove="remove(object)"
                        extra="extra" order-by="'name'"></terrama2-table>
      </div>
      <!-- ./col-md-12 -->
    </div>
    <!-- ./row -->
  </terrama2-box>

  <div id="exportModal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">Ã</span>
          </button>
          <h4 class="modal-title">Data Export</h4>
        </div>
        <div class="modal-body">
          <div ng-repeat="element in model" ng-show="element.id == currentProjectId">
            <input type="checkbox" value="{{ element.id }}" style="margin-right: 5px; float: left;" ng-model="projectsCheckboxes[element.id].project" ng-change="projectCheck(element)"/><div style="float: left;">{{ element.name }} (check all items)</div>
            <div style="clear: both; height: 20px;"></div>
            <div class="box collapsed-box" ng-show="dataProviders[element.id].length > 0">
              <div class="box-header with-border">
                <span class="box-title" style="font-size: 14px;">Data Servers</span>
                <div class="box-tools pull-right">
                  <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i></button>
                </div>
              </div>
              <div class="box-body" style="display: none;">
                <ul style="list-style-type: none; padding-left: 0 !important;">
                  <li ng-repeat="dataProvider in dataProviders[element.id]">
                    <input type="checkbox" value="{{ dataProvider.id }}" ng-model="projectsCheckboxes[element.id].dataProviders[dataProvider.id]" ng-disabled="projectsCheckboxes[element.id].project"/><div style="margin-top: -23px; margin-left: 18px;">{{ dataProvider.name }}</div>
                  </li>
                </ul>
              </div>
            </div>
            <div class="box collapsed-box" ng-show="dataSeries[element.id].length > 0">
              <div class="box-header with-border">
                <span class="box-title" style="font-size: 14px;">Data Series</span>
                <div class="box-tools pull-right">
                  <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i></button>
                </div>
              </div>
              <div class="box-body" style="display: none;">
                <ul style="list-style-type: none; padding-left: 0 !important;">
                  <li ng-repeat="dataSerie in dataSeries[element.id]">
                    <input type="checkbox" value="{{ dataSerie.id }}" ng-model="projectsCheckboxes[element.id].dataSeries[dataSerie.id]" ng-disabled="projectsCheckboxes[element.id].project"/><div style="margin-top: -23px; margin-left: 18px;">{{ dataSerie.name }}</div>
                  </li>
                </ul>
              </div>
            </div>
            <div class="box collapsed-box" ng-show="analysis[element.id].length > 0">
              <div class="box-header with-border">
                <span class="box-title" style="font-size: 14px;">Analysis</span>
                <div class="box-tools pull-right">
                  <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i></button>
                </div>
              </div>
              <div class="box-body" style="display: none;">
                <ul style="list-style-type: none; padding-left: 0 !important;">
                  <li ng-repeat="analysisItem in analysis[element.id]">
                    <input type="checkbox" value="{{ analysisItem.id }}" ng-model="projectsCheckboxes[element.id].analysis[analysisItem.id]" ng-disabled="projectsCheckboxes[element.id].project"/><div style="margin-top: -23px; margin-left: 18px;">{{ analysisItem.name }}</div>
                  </li>
                </ul>
              </div>
            </div>
            <div class="box collapsed-box" ng-show="views[element.id].length > 0">
              <div class="box-header with-border">
                <span class="box-title" style="font-size: 14px;">Views</span>
                <div class="box-tools pull-right">
                  <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-plus"></i></button>
                </div>
              </div>
              <div class="box-body" style="display: none;">
                <ul style="list-style-type: none; padding-left: 0 !important;">
                  <li ng-repeat="view in views[element.id]">
                    <input type="checkbox" value="{{ view.id }}" ng-model="projectsCheckboxes[element.id].views[view.id]" ng-disabled="projectsCheckboxes[element.id].project"/><div style="margin-top: -23px; margin-left: 18px;">{{ view.name }}</div>
                  </li>
                </ul>
              </div>
            </div>
            <hr/>
            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary pull-right" ng-click="extra.export(element)">Export</button>
            <div style="clear: both;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="importModal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">Ã</span>
          </button>
          <h4 class="modal-title">Select the project to which you want to import the data</h4>
        </div>
        <div class="modal-body">
          <div class="form-group" ng-show="model.length > 0">
            <div class="radio" ng-repeat="element in model">
              <label>
                <input type="radio" name="projectRadio" ng-value="{{ element.id }}" ng-model="$parent.projectRadio" checked>{{ element.name }}
              </label>
            </div>
          </div>
          <h4 style="text-align: center;" ng-show="model.length == 0">No projects found.</h4>
          <hr/>
          <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary pull-right" ng-click="extra.finalizeImportation()" ng-show="model.length > 0">Import</button>
          <div style="clear: both;"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
